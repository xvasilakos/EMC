package app;

import app.arguments.ArgumentsBean;
import app.properties.Preprocessor;
import exceptions.CriticalFailureException;
import exceptions.InvalidOrUnsupportedException;
import exceptions.NotIntiliazedException;
import exceptions.WrongOrImproperArgumentException;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintStream;
import java.util.Comparator;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.logging.Level;
import java.util.logging.Logger;
import static logging.LoggersRegistry.CONSOLE_LOGGER;
import sim.Scenario;
import sim.ScenariosFactory;
import sim.run.SimulationBaseRunner;
import utilities.Couple;
import utils.DebugUtils;

/**
 *
 * @author Xenofon Vasilakos xvas@aueb.gr
 */
public final class SimulatorApp {

    private final static SortedMap<Thread, SimulationBaseRunner> simWorkersMap = new TreeMap<>(new Comparator<Thread>() {
        @Override
        public int compare(Thread t1, Thread t2) {
            return t1.getName().compareTo(t2.getName());
        }
    });

    ///////////////////////////////////////////////////////////
    public static Preprocessor _preprocessedProps;
    public static ArgumentsBean mainArgs;
    private static String STATS_DIR_PATH;

    private static void exitByFail(String msg, Exception ex, int exitVal) {
        Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.SEVERE, msg, ex);
        ex.printStackTrace();
        System.exit(exitVal);
    }

    /**
     * @return the parsed mainArgs of method main() of this class
     */
    public static ArgumentsBean getMainArgs() {
        return mainArgs;
    }

    /**
     * @param args the command line main_mainArguments
     * @throws java.lang.InterruptedException
     */
    public static void main(String[] args) throws InterruptedException {

        /**
         * If manually stopped by user with "Kill -15"
         */
        Runtime.getRuntime().addShutdownHook(new Thread() {
            @Override
            public void run() {
                for (Thread nxtSimThrd : simWorkersMap.keySet()) {
                    if (nxtSimThrd.isAlive()) {
                        simWorkersMap.get(nxtSimThrd).runFinish();
                        nxtSimThrd.interrupt();
                    }
                }

                DebugUtils.close();
            }
        });

        Logger.getGlobal().setLevel(Level.INFO);

        //<editor-fold defaultstate="collapsed" desc="parse getMainArgs">
        try {
            mainArgs = ArgumentsBean.load(args);
        } catch (WrongOrImproperArgumentException ex) {
            exitByFail("Failed to load arguments propertly..\n", ex, -10);
        }
        Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.INFO, " Arguments parsed successfully\n");
        //</editor-fold>

        //<editor-fold defaultstate="collapsed" desc="defaultPreprocessor properties">
        String path = mainArgs.getPropertiesPath();
        try {
            _preprocessedProps = Preprocessor.process(path);
            Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.INFO, "Simulation properties file parsed successfully from path \"{0}\"\n", path);
        } catch (CriticalFailureException ex) {
            exitByFail("Loading properties failed: " + ex.getMessage(), ex, -20);
        }
        //</editor-fold>

        //<editor-fold defaultstate="collapsed" desc="reset global loggers after properties">
        try {
            logging.LoggersRegistry.resetGlobalLoggers(_preprocessedProps);
        } catch (InvalidOrUnsupportedException ex) {
            exitByFail("Failed to reset global loggers ..\n", ex, -25);
        }
        //</editor-fold>

        //<editor-fold defaultstate="collapsed" desc="init ScenariosFactory">
        try {
            ScenariosFactory.init(_preprocessedProps, mainArgs);
            int num = ScenariosFactory.unconsumedScenariosNum();
            Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(
                    Level.INFO, "{0} simulation scenario{1} initialized\n",
                    new Object[]{num, num > 1 ? "s" : ""}
            );
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ScenariosFactory.printScenarios(new PrintStream(baos));
            Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.CONFIG, "{0}\n", baos.toString());
        } catch (CriticalFailureException | NotIntiliazedException ex) {
            exitByFail("\"ScenariosFactory FAILED!", ex, -30);
        }
        //</editor-fold>

        initStatsDir();
        DebugUtils.init();

        //<editor-fold defaultstate="collapsed" desc="spawn simulation thread for each scenario">
        Scenario nxtScenario;
        try {
            while ((nxtScenario = ScenariosFactory.consumeNextSetup()) != null) {
                try {
                    Couple<Thread, SimulationBaseRunner> launched = SimulationBaseRunner.launchSimulationThread(nxtScenario);
                    simWorkersMap.put(launched.getFirst(), launched.getSecond());

                    Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(
                            Level.INFO, launched.getFirst().getName() + " thread for scenario {0} launched.\n",
                            nxtScenario.getIDStr()
                    );
                    Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(
                            Level.FINEST, "Details:\n{0}\n", nxtScenario.toString()
                    );

                } catch (CriticalFailureException crex) {
                    Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(
                            Level.SEVERE, "Simulation thread failed for scenario setup:\n"
                            + nxtScenario.toString(), crex
                    );
                }
            }//while
        } catch (NotIntiliazedException ex) {
            exitByFail("Simulator application  terminates unsuccessfully.\n", ex, -40);
        }
        //</editor-fold>

        CONSOLE_LOGGER.exiting(SimulatorApp.class.getCanonicalName(), "main");
    }

    public static String currentSimulationStatsDirPath() {
        return STATS_DIR_PATH;
    }

    private static void initStatsDir() {
        try {
            STATS_DIR_PATH
                    = System.getProperty("user.home") + "/"
                    + _preprocessedProps.getValues(app.properties.StatsProperty.STATS__OUTPUTDIR).getFirst().get(0);

            //AggregatorApp.STATS_DIR_PATH;//@TODO temporary solution
            File parent = new File(STATS_DIR_PATH);
            parent.mkdirs();

            String runsRecorded = "runs_recorded.txt";
            File file = new File(parent, runsRecorded);
            int statusRecorded = 3;
            try {
                statusRecorded = file.createNewFile() ? 1 : 0;
            } catch (IOException ex) {
                statusRecorded = 3; //in case of error!
            }
            //<editor-fold defaultstate="collapsed" desc="case: error with creating recorded runs">
            if (statusRecorded == 3) {
                int nxtRunNum = (int) (1000 * Math.random());
                STATS_DIR_PATH = STATS_DIR_PATH + "/rand_stat_id-" + nxtRunNum;
                String msg = "Cannot create file " + runsRecorded + "in path \"" + parent.getCanonicalPath() + "\". Results will be saved in directory:\n"
                        + " \"" + STATS_DIR_PATH + " \"";
                Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.WARNING, msg);
                System.out.println("Press enter to continue ..");
                System.in.read();
            } //</editor-fold>
            //<editor-fold defaultstate="collapsed" desc="case: keeping stats for the first simTime">
            if (statusRecorded == 1) {
                try (BufferedWriter bout = new BufferedWriter(new FileWriter(file));) {
                    bout.append("0");
                }
                STATS_DIR_PATH += "/000";
            } //</editor-fold>
            try (BufferedReader bin = new BufferedReader(new FileReader(file));) {
                //<editor-fold defaultstate="collapsed" desc="case: keeping stats at consequent times">
                if (statusRecorded == 0) {
                    int nxtRunNum = -1;
                    try {
                        String nxtRunNum_str = bin.readLine().trim();
                        bin.close();
                        nxtRunNum = Integer.parseInt(nxtRunNum_str) + 1;

                        if (nxtRunNum < 100 && nxtRunNum > 9) {
                            STATS_DIR_PATH = STATS_DIR_PATH + "/0" + nxtRunNum;
                        } else if (nxtRunNum < 10) {
                            STATS_DIR_PATH = STATS_DIR_PATH + "/00" + nxtRunNum;
                        } else {
                            STATS_DIR_PATH = STATS_DIR_PATH + "/" + nxtRunNum;
                        }
                    } catch (IOException | NumberFormatException ex) {
                        //<editor-fold defaultstate="collapsed" desc="case: error with reading recorded runs">
                        nxtRunNum = (int) (1000 * Math.random());
                        STATS_DIR_PATH = STATS_DIR_PATH + "/rand_stat_id-" + nxtRunNum;
                        String msg = "Cannot read from file " + runsRecorded + ". Results will be saved in directory:\n"
                                + " \"" + STATS_DIR_PATH + " \"";
                        Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.WARNING, msg, ex);
                        System.out.println("Press enter to continue ..");
                        System.in.read();
                        //</editor-fold>
                    }
                    try (BufferedWriter bout = new BufferedWriter(new FileWriter(file));) {
                        bout.append(String.valueOf(nxtRunNum));
                    } catch (IOException ex) {
                        //<editor-fold defaultstate="collapsed" desc="case: error with writting to recorded runs">
                        nxtRunNum = (int) (1000 * Math.random());
                        STATS_DIR_PATH = STATS_DIR_PATH + "/rand_stat_id-" + nxtRunNum;
                        String msg = "Cannot write to file " + runsRecorded + ". Results will be saved in directory:\n"
                                + " \"" + STATS_DIR_PATH + " \"";
                        Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.WARNING, msg, ex);
                        System.out.println("Press enter to continue ..");
                        System.in.read();
                        //</editor-fold>
                    }
                }
                //</editor-fold>
            } catch (IOException ex) {
                throw new Exception(ex);
            }
        } catch (Exception ex) {
            try {
                int nxtRunNum = (int) (1000 * Math.random());
                STATS_DIR_PATH = STATS_DIR_PATH + "/rand_stat_id-" + nxtRunNum;
                String msg = "Problem with intiliazing path to output dir for statistics results.";
                Logger.getLogger(SimulatorApp.class.getCanonicalName()).log(Level.WARNING, msg, ex);
                System.out.println("Results will be logged in: " + STATS_DIR_PATH);
                System.out.println("Press enter to continue ..");
                System.in.read();
            } catch (IOException ex1) {
                //ignore
            }
        }
    }
}//class
