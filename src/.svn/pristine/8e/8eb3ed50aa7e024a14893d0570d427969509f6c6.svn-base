package utils;

import app.SimulatorApp;
import caching.base.AbstractCachingPolicy;
import caching.incremental.EMC;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintStream;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashSet;
import java.util.logging.Level;
import java.util.logging.Logger;
import sim.run.SimulationBaseRunner;
import sim.content.Chunk;
import sim.space.cell.smallcell.SmallCell;
import sim.space.users.User;

/**
 *
 * @author xvas
 */
public class DebugUtils {

    private static HashSet<Chunk> set = new HashSet();

    public static void setAdd(Chunk c) {set.add(c);}
    public static boolean setContains(Chunk c) {return set.contains(c);}

    public static PrintStream printer;//yyy

    private static final int monitorCellID = -1;//  21;
    private static final int monitorUID = -1;//  21;
    private static final AbstractCachingPolicy _policy = EMC.instance();//EPCPopNoRplc_c1.instance();

    public static void init() {
        try {
            SimpleDateFormat sdfDate = new SimpleDateFormat("yy-MM-dd");
            SimpleDateFormat sdfTime = new SimpleDateFormat("HH-mm-ss");
            Date now = new Date();
            String name = sdfTime.format(now) + "runInfo.txt";

            String parent = SimulatorApp.currentSimulationStatsDirPath() + "[" + sdfDate.format(now) + "]";
            new File(parent).mkdirs();

            printer = new PrintStream(parent + "/" + name);

        } catch (FileNotFoundException ex) {
            Logger.getLogger(DebugUtils.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    public static void flushLogs() {
        printer.flush();
    }

    public static void close() {
        printer.close();
    }

    public static void appendLogNewRecord(String txt, SmallCell sc, caching.base.AbstractCachingPolicy policy) {
        if ((sc.getID() == monitorCellID) && policy.getClass() == _policy.getClass()) {
            printer.append("\n\n");
            printer.append("{simID=");
            printer.append("" + sc.getSim().getID());
            printer.append("}");

            printer.append("[simTime=" + sc.simTime() + "]");
            printer.append("\t" + txt);
        }
    }

    public static void appendLogNewRecord(SimulationBaseRunner theSim, String txt) {
//        printer.append("\n\n");
//        printer.append("{simID=");
//        printer.append("" + theSim.getID());
//        printer.append("}");

        printer.append("[simTime=" + theSim.simTime() + "]");
        printer.append("\t" + txt);
    }

    public static void trackUser(boolean newRec, String txt, User usr, boolean overrideMU) {
        if (usr.getID() == monitorUID
                || overrideMU) {

            printer.append("\n\n");
            printer.append("{simID=");
            printer.append("" + usr.getSim().getID());
            printer.append("}");

            if (newRec) {
                printer.append(usr.simTimeStr());
                printer.append(" user: " + usr.getID());//toSynopsisString());
                printer.append("\n");
            }
            printer.append(txt);
        }
    }

    public static void trackSC(boolean newRec, String txt, SmallCell sc, 
            boolean overrideSC) {
        if (sc.getID() == monitorCellID || overrideSC) {

            printer.append("\n\n");
            printer.append("{simID=");
            printer.append("" + sc.getSim().getID());
            printer.append("}");

            if (newRec) {
                printer.append(sc.simTimeStr());
                printer.append("\n");
            }
            printer.append(txt);
        }
    }

    public static void trackSCOut(boolean newRec, String txt, SmallCell sc, boolean overrideSC) {
        if (sc.getID() == 13 || overrideSC) {
            try {
                System.out.append("\n");
                if (newRec) {
                    System.out.append(sc.simTimeStr());
                    System.out.append("\n");
                }
                System.out.append(txt);
                System.out.println();
                System.in.read();
            } catch (IOException ex) {

            }
        }

    }

}
